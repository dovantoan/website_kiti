
@{
    ViewBag.Title = "CartDetails";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@using titi.Language;
<style>
    .cart_product{margin:0px}
</style>
<div class="row">
    <section id="cart_items">
        <div class="breadcrumbs">
            <ol class="breadcrumb">
                <li><a href="#">@language.Home</a></li>
                <li class="active">Shopping Cart</li>
            </ol>
        </div>
        <div class="table-responsive cart_info">
            <table class="table table-condensed">
                <thead>
                    <tr class="cart_menu">
                        <td class="image">@language.Item</td>
                        <td class="description">@language.Description</td>
                        <td class="description">@language.Price</td>
                        <td class="quantity">@language.Quantity</td>
                        <td class="total">Tạm tính</td>
                        <td>Option</td>
                    </tr>
                </thead>
                <tbody id="cart-items">
                </tbody>
                <tfoot>
                    <tr>
                        <td><a href="javascript:;" class="btn btn-danger" data-cesta-feira-clear-basket id="btnClearCart" style="display:none" >Làm mới giỏ hàng</a></td>
                        <td>  </td>
                        <td>@language.Total</td>
                        <td class="text-right" id="total-value"><strong>0 VND</strong></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td colspan="4"></td>
                        <td><a href="@Url.Action("CheckOut","Products")" class="btn btn-success" id="btnPayment" style="display:none">Thanh toán</a></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </section>

    
</div>
<script type="application/javascript">
    function initListaOrcamento() {
      var products = $.CestaFeira({
          debug: true
        }).getItems(),
        totalValueTemp = 0,
        $cartItems = $('#cart-items');
      if (!products) {
        console.log("No items in cart!");
        $('#btnPayment').hide();
        $('#btnClearCart').hide();
        return;
      }

      function updateTotalValue() {

        var totalValue = 0;

        $.each($('[data-item-total-value]'), function (index, item) {
          totalValue += $(item).data('item-total-value');
        });

        $('#total-value').html(parseFloat(totalValue).toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,") + " VND");
        if(totalValue == 0){
            $('#btnPayment').hide();
            $('#btnClearCart').hide();
        }
      }

      function mountLayout(index, data) {
        var totalValueTemp = parseFloat(data.unity_price) * parseInt(data.quantity);
        var idQty = 'qty_'+data.product_code;
        var idbtnDown = 'touchspinDown_'+data.product_code;
        var idbtnUp = 'touchspinUp_'+data.product_code;

        var property = '';
        if(data.property!=''){
            var tem = data.property.split('_');
            property = tem[1]+ ' '+ tem[3];
        }
        var $layout = "<tr id='product-"+ index +"'><td class='col-sm-8 col-md-5'><div class='media'>" +
          "<img class='d-flex align-self-center mr-3' src='"+data.item_url+"' alt='' width='110px' />" +
          "<div class='media-body'>" +
          "<h5 class='mt-0'>"+ data.product_name +"</h5>" +
          "</div></div></td><td class='col-sm-1 col-md-1' style='text-align: center'><p>Mã Sản Phẩm: " + data.product_code + "</p><p>"+property+"</p>"+
          "<td class='col-sm-1 col-md-2 text-center'><strong>"+ data.unity_fprice +" VND</strong></td>" +
          "<td class='col-sm-1 col-md-1'>"+
            "<form action='' class='form' data-cesta-feira-form >"+
                "<div class='cart_quantity_button' style='display:table;width:110px'>"+
                "<span class='input-group-btn' style='float:left;display:table;margin-top:0px'>"+
                                            "<button class='btn btn-default bootstrap-touchspin-down' id='"+idbtnDown+"' type='submit' onclick='touchspinDown(this)'>-</button>"+
                                        "</span>"+
                "<input id='"+idQty+"' type='tel' value='"+data.quantity+"' name='quantity' style='width:40px;float:left;display:block;border-radius:0px !important' class='form-control' min='1' max='100' data-cesta-feira-attribute />"+
                "<span class='input-group-btn' style='float:left;display:table;margin-top:0px'>"+
                                            "<button class='btn btn-default bootstrap-touchspin-up' id='"+idbtnUp+"' type='submit' onclick='touchspinUp(this)'>+</button>"+
                                        "</span>"+
                "</div>"+
                "<input type='hidden' value='"+data.product_name+"' name='product_name' data-cesta-feira-attribute >"+
                "<input type='hidden' value='"+data.unity_price+"' name='unity_price' data-cesta-feira-attribute >"+
                "<input type='hidden' value='"+index+"' data-cesta-feira-item-id >"+
                "<input type='hidden' value='"+data.item_type+"' name='item_type' data-cesta-feira-attribute >"+
                "<input type='hidden' value='"+data.item_url+"' name='item_url' data-cesta-feira-attribute >"+
                "<input type='hidden' value='"+data.unity_fprice+"' name='unity_fprice' data-cesta-feira-attribute >"+
                "<input type='hidden' value='"+data.product_code+"' name='product_code' data-cesta-feira-attribute >"+
                "<input type='hidden' value='"+data.property+"' name='property' data-cesta-feira-attribute >"+
            "</form>"+
          "</td>"+
          "<td class='col-sm-1 col-md-1 text-center' data-item-total-value='"+totalValueTemp+"'><strong>"+parseFloat(totalValueTemp).toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,")+" VND</strong></td>" +
          "<td class='col-sm-1 col-md-1'>" +
          "<a href='javascript:;' class='btn btn-danger fa fa-times' data-cesta-feira-delete-item='"+ index +"'><span class='sr-only'>Remove</span></a>" +
          "</td></tr>";

        $cartItems.append($layout);
      }


      $.each(products, function (index, value) {
        mountLayout(index, value);
        $('#btnPayment').show();
        $('#btnClearCart').show();
      });

      updateTotalValue();

      $(document).on('click', 'a[data-cesta-feira-delete-item]', function(e) {
        e.preventDefault();

        var productId = $(this).data('cesta-feira-delete-item');

        if($(document).on('cesta-feira-item-deleted')){
          $('#product-'+productId).fadeOut(500, function() {
            $(this).remove();
            updateTotalValue();
          });
        }
      });

      $(document).on('cesta-feira-clear-basket', function (e) {
        $('#cart-items tr').each(function (index, value) {
          $(value).fadeOut(500, function() {
            $(this).remove();
            updateTotalValue();
          });
        });
      });

    }

    function touchspinUp(e){
    var qty = 'qty_'+e.id.split('_')[1];
        if ($('#'+qty).val() < 100) {
                $('#'+qty).val(Number($('#'+qty).val()) + 1);
                e.form.submit();
            }
        //initListaOrcamento();
    }
    function touchspinDown(e){
    var qty = 'qty_'+e.id.split('_')[1];
        if ($('#'+qty).val() > 1) {
                $('#'+qty).val(Number($('#'+qty).val()) - 1);
                e.form.submit();
            }
    }

    $(document).ready(function () {

      initListaOrcamento();

    });
</script>
